<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi ç°¡æ˜“æ”¯ä»˜æ¸¬è©¦</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
<body>
    <h1>Pi æ”¯ä»˜æ¸¬è©¦ </h1>
    
    <button onclick="login()">1. ç™»å…¥ Pi å¸³è™Ÿ</button>
    <button onclick="pay()" style="margin-top:20px">2. ç™¼èµ·æ”¯ä»˜</button>
    
    <h2>ç”¨æˆ¶è³‡è¨Šï¼š</h2>
    <pre id="user-info">å°šæœªç™»å…¥</pre>
    
    <script>
        let currentUser = null;

        // åˆå§‹åŒ– SDK
        Pi.init({ 
            version: "2.0",
            sandbox: true // âœ… å¿…é ˆå•Ÿç”¨æ²™ç›’æ¨¡å¼
        });

        // ç™»å…¥åŠŸèƒ½
        async function login() {
            try {
                const authResult = await Pi.authenticate(['username', 'payments', 'wallet_address']);
                currentUser = authResult.user;
                document.getElementById('user-info').textContent = JSON.stringify(authResult.user, null, 2);
                alert(`ç™»å…¥æˆåŠŸï¼ç”¨æˆ¶å: ${authResult.user.username}`);
				console.log(authResult.accessToken); // ç²å– Access Token
				console.log(authResult.user.uid);    // ç²å–ä½¿ç”¨è€…çš„ uidï¼ˆä½†æœªé©—è­‰ï¼‰
            } catch (error) {
                alert("ç™»å…¥å¤±æ•—: " + error.message);
            }
        }

        // æ”¯ä»˜åŠŸèƒ½ (è·³éŽä¼ºæœå™¨é©—è­‰)
    async function pay() {
    if (!currentUser) return alert("è«‹å…ˆç™»å…¥ï¼");

    try {
        const paymentData = {
            amount: 3.14,
            memo: "æ¸¬è©¦æ”¯ä»˜",
            metadata: { test: "123" }
        };

        const paymentCallbacks = {
            onReadyForServerApproval: async (paymentId) => {
                console.log("æ”¯ä»˜ç­‰å¾…æ‰¹å‡†:", paymentId);

                // ðŸ”¹ é€™è£¡è«‹æ±‚ä¼ºæœå™¨æ‰¹å‡†æ”¯ä»˜
                try {
                    const response = await fetch("https://tubular-kelpie-4997f4.netlify.app/.netlify/functions/approvePayment", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ paymentId })
                    });

                    const result = await response.json();
                    if (result.success) {
                        console.log("æ”¯ä»˜å·²æ‰¹å‡†ï¼Œäº¤æ˜“ID:", result.txid);
                    } else {
                        console.error("æ‰¹å‡†æ”¯ä»˜å¤±æ•—:", result.error);
                    }
                } catch (error) {
                    console.error("ä¼ºæœå™¨éŒ¯èª¤:", error);
                }
            },
            onReadyForServerCompletion: (paymentId, txid) => {
                alert("ðŸ’° æ”¯ä»˜æˆåŠŸï¼äº¤æ˜“ID: " + txid);
            },
            onCancel: (paymentId) => {
                alert("âŒ ç”¨æˆ¶å–æ¶ˆæ”¯ä»˜");
            },
            onError: (error) => {
                alert("æ”¯ä»˜éŒ¯èª¤: " + error.message);
            }
        };

        const payment = await Pi.createPayment(paymentData, paymentCallbacks);
        console.log("æ”¯ä»˜å·²ç™¼èµ·:", payment);
    } catch (error) {
        alert("æ”¯ä»˜å¤±æ•—: " + error.message);
    }
}

    </script>
</body>
</html>
