<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi ç°¡æ˜“æ”¯ä»˜æ¸¬è©¦</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
<body>
    <h1>Pi æ”¯ä»˜æ¸¬è©¦ (ç„¡ä¼ºæœå™¨é©—è­‰)</h1>
    
    <button onclick="login()">1. ç™»å…¥ Pi å¸³è™Ÿ</button>
    <button onclick="pay()" style="margin-top:20px">2. ç™¼èµ·æ”¯ä»˜</button>
    
    <h2>ç”¨æˆ¶è³‡è¨Šï¼š</h2>
    <pre id="user-info">å°šæœªç™»å…¥</pre>
    
    <script>
        let currentUser = null;

        // åˆå§‹åŒ– SDK
        Pi.init({ 
            version: "2.0",
            sandbox: true // âœ… å¿…é ˆå•Ÿç”¨æ²™ç›’æ¨¡å¼
        });

        // ç™»å…¥åŠŸèƒ½
       async function login() {
    try {
        // 1ï¸âƒ£ é€²è¡Œ Pi Network èº«ä»½é©—è­‰
        const authResult = await Pi.authenticate(['username', 'wallet_address']);
        console.log("âœ… ç™»å…¥æˆåŠŸ", authResult);

        // 2ï¸âƒ£ è™•ç†æœªå®Œæˆçš„æ”¯ä»˜
        Pi.onIncompletePaymentFound(async (payment) => {
            console.warn("âš ï¸ ç™¼ç¾æœªå®Œæˆçš„æ”¯ä»˜:", payment);
            await handleIncompletePayment(payment);
        });

        alert("ç™»å…¥æˆåŠŸï¼");
    } catch (error) {
        console.error("âŒ ç™»å…¥å¤±æ•—:", error);
        alert("ç™»å…¥å¤±æ•—ï¼š" + error.message);
    }
}
async function handleIncompletePayment(payment) {
    try {
        if (!payment || !payment.identifier) {
            console.warn("âš ï¸ ç„¡æ•ˆçš„æœªå®Œæˆæ”¯ä»˜");
            return;
        }

        console.log("ğŸ”„ æª¢æŸ¥æ”¯ä»˜ç‹€æ…‹:", payment);

        // 1ï¸âƒ£ å‘ä½ çš„å¾Œç«¯è«‹æ±‚æ”¯ä»˜ç¢ºèª
        const response = await fetch("https://tubular-kelpie-4997f4.netlify.app/.netlify/functions/verifyPayment", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ paymentId: payment.identifier }),
        });

        const result = await response.json();
        console.log("âœ… å¾Œç«¯å›æ‡‰:", result);

        if (result.status === "completed") {
            console.log("âœ… ä»˜æ¬¾å·²ç¶“å®Œæˆï¼Œç„¡éœ€é€²ä¸€æ­¥æ“ä½œ");
        } else if (result.status === "pending") {
            console.log("ğŸ”„ å˜—è©¦å®Œæˆä»˜æ¬¾...");
            await completePayment(payment);
        } else {
            console.warn("âš ï¸ æœªçŸ¥ç‹€æ…‹ï¼Œå¯èƒ½éœ€è¦æ‰‹å‹•æª¢æŸ¥");
        }
    } catch (error) {
        console.error("âŒ è™•ç†æœªå®Œæˆæ”¯ä»˜å¤±æ•—:", error);
    }
}
async function completePayment(payment) {
    try {
        console.log("ğŸ“Œ å˜—è©¦å®Œæˆæ”¯ä»˜:", payment.identifier);

        const response = await Pi.createPayment(payment);
        console.log("âœ… æ”¯ä»˜å®Œæˆ:", response);

        alert("æ”¯ä»˜æˆåŠŸï¼");
    } catch (error) {
        console.error("âŒ æ”¯ä»˜å®Œæˆå¤±æ•—:", error);
        alert("æ”¯ä»˜å¤±æ•—ï¼š" + error.message);
    }
}


        // æ”¯ä»˜åŠŸèƒ½ (è·³éä¼ºæœå™¨é©—è­‰)
    async function pay() {
    if (!currentUser) return alert("è«‹å…ˆç™»å…¥ï¼");

    try {
        const paymentData = {
            amount: 3.14,
            memo: "æ¸¬è©¦æ”¯ä»˜",
            metadata: { test: "123" }
        };

        const paymentCallbacks = {
            onReadyForServerApproval: async (paymentId) => {
                console.log("æ”¯ä»˜ç­‰å¾…æ‰¹å‡†:", paymentId);

                // ğŸ”¹ é€™è£¡è«‹æ±‚ä¼ºæœå™¨æ‰¹å‡†æ”¯ä»˜
                try {
                    const response = await fetch("https://tubular-kelpie-4997f4.netlify.app/.netlify/functions/approvePayment", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ paymentId })
                    });

                    const result = await response.json();
                    if (result.success) {
                        console.log("æ”¯ä»˜å·²æ‰¹å‡†ï¼Œäº¤æ˜“ID:", result.txid);
                    } else {
                        console.error("æ‰¹å‡†æ”¯ä»˜å¤±æ•—:", result.error);
                    }
                } catch (error) {
                    console.error("ä¼ºæœå™¨éŒ¯èª¤:", error);
                }
            },
            onReadyForServerCompletion: (paymentId, txid) => {
                alert("ğŸ’° æ”¯ä»˜æˆåŠŸï¼äº¤æ˜“ID: " + txid);
            },
            onCancel: (paymentId) => {
                alert("âŒ ç”¨æˆ¶å–æ¶ˆæ”¯ä»˜");
            },
            onError: (error) => {
                alert("æ”¯ä»˜éŒ¯èª¤: " + error.message);
            }
        };

        const payment = await Pi.createPayment(paymentData, paymentCallbacks);
        console.log("æ”¯ä»˜å·²ç™¼èµ·:", payment);
    } catch (error) {
        alert("æ”¯ä»˜å¤±æ•—: " + error.message);
    }
}

    </script>
</body>
</html>
