<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi 支付测试</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
<body>
    <h1>Pi 支付测试 (无服务器验证)</h1>
    
    <button onclick="login()">1. 登录 Pi 帐号</button>
    <button onclick="pay()" style="margin-top:20px">2. 发起支付</button>
    
    <h2>用户信息：</h2>
    <pre id="user-info">尚未登录</pre>
    
    <script>
        let currentUser = null;

        // 初始化 SDK
        Pi.init({ 
            version: "2.0",
            sandbox: true // 必须启用沙盒模式
        });

        // 登录功能
        async function login() {
            try {
                const authResult = await Pi.authenticate(['username', 'wallet_address'], onIncompletePaymentFound);
                currentUser = authResult.user;
                document.getElementById("user-info").textContent = JSON.stringify(authResult.user, null, 2);
                alert("登录成功！");
            } catch (error) {
                console.error("登录失败:", error);
                alert("登录失败：" + error.message);
            }
        }

        // 处理未完成支付
        function onIncompletePaymentFound(payment) {
            console.log("发现未完成支付:", payment);
            // 在这里您可以进行支付状态检查，并根据需要发起支付完成请求
            handleIncompletePayment(payment);
        }

        async function handleIncompletePayment(payment) {
            try {
                // 1️⃣ 向您的后端请求支付确认
                const response = await fetch("https://your-backend-url.com/verifyPayment", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ paymentId: payment.identifier }),
                });

                const result = await response.json();
                console.log("后端响应:", result);

                if (result.status === "completed") {
                    console.log("付款已完成");
                } else if (result.status === "pending") {
                    console.log("尝试完成付款...");
                    await Pi.completePayment(payment.identifier); // 完成支付
                    console.log("支付已完成");
                } else {
                    console.warn("支付状态未知");
                }
            } catch (error) {
                console.error("处理未完成支付失败:", error);
            }
        }

        // 支付功能
        async function pay() {
            if (!currentUser) return alert("请先登录！");

            try {
                const paymentData = {
                    amount: 3.14,
                    memo: "测试支付",
                    metadata: { test: "123" },
                    uid: currentUser.uid // 必须提供 uid
                };

                const paymentCallbacks = {
                    onReadyForServerApproval: async (paymentId) => {
                        console.log("支付等待批准:", paymentId);

                        try {
                            const response = await fetch("https://your-backend-url.com/approvePayment", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ paymentId })
                            });

                            const result = await response.json();
                            if (result.success) {
                                console.log("支付已批准，交易ID:", result.txid);
                            } else {
                                console.error("支付批准失败:", result.error);
                            }
                        } catch (error) {
                            console.error("服务器错误:", error);
                        }
                    },
                    onReadyForServerCompletion: (paymentId, txid) => {
                        alert("支付成功！交易ID: " + txid);
                    },
                    onCancel: (paymentId) => {
                        alert("用户取消支付");
                    },
                    onError: (error) => {
                        alert("支付错误: " + error.message);
                    }
                };

                const payment = await Pi.createPayment(paymentData, paymentCallbacks);
                console.log("支付已发起:", payment);
            } catch (error) {
                alert("支付失败: " + error.message);
            }
        }
    </script>
</body>
</html>
