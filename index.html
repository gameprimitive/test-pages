<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi 简易支付测试</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <script>
        // 初始化 SDK
        Pi.init({ 
            version: "2.0",
            sandbox: true // ✅ 必须启用沙盒模式
        });

        let currentUser = null; // 定义 currentUser 变量

        // 处理未完成的支付
        function onIncompletePaymentFound(payment) {
            console.log("⚠️ 发现未完成的支付:", payment);
            // 在此处理未完成的支付，例如向服务器请求支付状态
            handleIncompletePayment(payment);
        }

        // 登录功能
        async function login() {
            try {
                // 1️⃣ 进行 Pi Network 身份验证
                const authResult = await Pi.authenticate(['username', 'wallet_address', 'payments'], onIncompletePaymentFound);
                console.log("✅ 登录成功", authResult);
                currentUser = authResult.user; // 将用户信息存储在 currentUser 变量中
                // 处理登录后的逻辑
                alert("登录成功！");
            } catch (error) {
                console.error("❌ 登录失败:", error);
                alert("登录失败：" + error.message);
            }
        }




  async function handleIncompletePayment(payment) {
  try {
    const response = await fetch("https://tubular-kelpie-4997f4.netlify.app/.netlify/functions/verifyPayment", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ paymentId: payment.identifier }),
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const paymentData = await response.json();
    console.log("🔍 Pi API 原始响应:", paymentData);

    // 状态解析逻辑
    const status = paymentData.status || {};
    const isCancelled = status.cancelled || status.user_cancelled;

    // 状态决策树
    if (isCancelled) {
      console.log("❌ 支付已被取消");
      await Pi.cancelPayment(payment.identifier);
      return;
    }

    if (status.developer_completed) {
      console.log("✅ 支付已完成");
      return;
    }

    if (status.transaction_verified) {
      console.log("🔄 交易已验证，正在完成支付流程...");
      await Pi.completePayment(payment.identifier);
      console.log("✅ 支付最终确认完成");
      return;
    }

    if (status.developer_approved) {
      console.log("⚠️ 支付已批准但未验证，等待区块链确认...");
      // 添加轮询检查
      const checkInterval = setInterval(async () => {
        const updated = await verifyPayment(payment.identifier);
        if (updated.status.transaction_verified) {
          clearInterval(checkInterval);
          await Pi.completePayment(payment.identifier);
        }
      }, 5000);
      return;
    }

    console.warn("🔄 支付处于初始状态，等待处理...");
  } catch (error) {
    console.error("❌ 支付状态检查失败:", error);
    setTimeout(() => handleIncompletePayment(payment), 10000); // 10秒后重试
  }
}

        // 支付功能
        async function pay() {
            if (!currentUser) return alert("请先登录！");

            try {
                const paymentData = {
                    amount: 3.14,
                    memo: "测试支付",
                    metadata: { test: "123" },
                    uid: currentUser.uid // 使用 currentUser 变量
                };

                const paymentCallbacks = {
                    onReadyForServerApproval: async (paymentId) => {
                        console.log("支付等待批准:", paymentId);
                        // 向后端请求批准支付
                        const response = await fetch("https://tubular-kelpie-4997f4.netlify.app/.netlify/functions/approvePayment", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ paymentId })
                        });
                        const result = await response.json();
                        if (result.success) {
                            console.log("支付已批准，交易ID:", result.txid);
                        } else {
                            console.error("支付批准失败:", result.error);
                        }
                    },
                    onReadyForServerCompletion: (paymentId, txid) => {
                        alert("支付成功！交易ID: " + txid);
                    },
                    onCancel: (paymentId) => {
                        alert("用户取消支付");
                    },
                    onError: (error) => {
                        alert("支付错误: " + error.message);
                    }
                };

                const payment = await Pi.createPayment(paymentData, paymentCallbacks);
                console.log("支付已发起:", payment);
            } catch (error) {
                alert("支付失败: " + error.message);
            }
        }
    </script>
</head>
<body>
    <h1>Pi 支付测试 </h1>
    
    <button onclick="login()">1. 登录 Pi 账号</button>
    <button onclick="pay()" style="margin-top:20px">2. 发起支付</button>
    
    <h2>用户信息：</h2>
    <pre id="user-info">尚未登录</pre>
</body>
</html>
