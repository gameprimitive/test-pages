<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi 簡易支付測試</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
<body>
    <h1>Pi 支付測試 </h1>
    
    <button onclick="login()">1. 登入 Pi 帳號</button>
    <button onclick="pay()" style="margin-top:20px">2. 發起支付</button>
    
    <h2>用戶資訊：</h2>
    <pre id="user-info">尚未登入</pre>
    
    <script>
        let currentUser = null;

        // 初始化 SDK
        Pi.init({ 
            version: "2.0",
            sandbox: true // ✅ 必須啟用沙盒模式
        });

        // 登入功能
        async function login() {
            try {
                const authResult = await Pi.authenticate(['username', 'payments', 'wallet_address']);
                currentUser = authResult.user;
                document.getElementById('user-info').textContent = JSON.stringify(authResult.user, null, 2);
                alert(`登入成功！用戶名: ${authResult.user.username}`);
				console.log(authResult.accessToken); // 獲取 Access Token
				console.log(authResult.user.uid);    // 獲取使用者的 uid（但未驗證）
            } catch (error) {
                alert("登入失敗: " + error.message);
            }
        }

        // 支付功能 (跳過伺服器驗證)
    async function pay() {
    if (!currentUser) return alert("請先登入！");

    try {
        const paymentData = {
            amount: 3.14,
            memo: "測試支付",
            metadata: { test: "123" }
        };

        const paymentCallbacks = {
            onReadyForServerApproval: async (paymentId) => {
                console.log("支付等待批准:", paymentId);

                // 🔹 這裡請求伺服器批准支付
                try {
                    const response = await fetch("https://tubular-kelpie-4997f4.netlify.app/.netlify/functions/approvePayment", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ paymentId })
                    });

                    const result = await response.json();
                    if (result.success) {
                        console.log("支付已批准，交易ID:", result.txid);
                    } else {
                        console.error("批准支付失敗:", result.error);
                    }
                } catch (error) {
                    console.error("伺服器錯誤:", error);
                }
            },
            onReadyForServerCompletion: (paymentId, txid) => {
                alert("💰 支付成功！交易ID: " + txid);
            },
            onCancel: (paymentId) => {
                alert("❌ 用戶取消支付");
            },
            onError: (error) => {
                alert("支付錯誤: " + error.message);
            }
        };

        const payment = await Pi.createPayment(paymentData, paymentCallbacks);
        console.log("支付已發起:", payment);
    } catch (error) {
        alert("支付失敗: " + error.message);
    }
}

    </script>
</body>
</html>
