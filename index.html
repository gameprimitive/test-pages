<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi ç°¡æ˜“æ”¯ä»˜æ¸¬è©¦</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
<body>
    <h1>Pi æ”¯ä»˜æ¸¬è©¦ (ç„¡ä¼ºæœå™¨é©—è­‰)</h1>
    
    <button onclick="login()">1. ç™»å…¥ Pi å¸³è™Ÿ</button>
    <button onclick="pay()" style="margin-top:20px">2. ç™¼èµ·æ”¯ä»˜</button>
    
    <h2>ç”¨æˆ¶è³‡è¨Šï¼š</h2>
    <pre id="user-info">å°šæœªç™»å…¥</pre>
    
    <script>
        let currentUser = null;

        // åˆå§‹åŒ– SDK
        Pi.init({ 
            version: "2.0",
            sandbox: true // âœ… å¿…é ˆå•Ÿç”¨æ²™ç›’æ¨¡å¼
        });

        // ç™»å…¥åŠŸèƒ½
      async function login() {
    try {
        // 1ï¸âƒ£ é€²è¡Œ Pi Network ç™»å…¥
        const authResult = await Pi.authenticate(['username', 'wallet_address']);
        currentUser = authResult.user;
        console.log("âœ… ç™»å…¥æˆåŠŸï¼", authResult.user);

        // 2ï¸âƒ£ æª¢æŸ¥æ˜¯å¦æœ‰æœªè™•ç†çš„æ”¯ä»˜
        const payments = await Pi.fetchPayments();
        console.log("ğŸ“Œ æœªå®Œæˆæ”¯ä»˜åˆ—è¡¨:", payments);

        // 3ï¸âƒ£ éæ­·æ‰€æœ‰æ”¯ä»˜ï¼Œæ‰¾åˆ°æœªå®Œæˆçš„
        let hasPendingPayment = false;
        for (let payment of payments) {
            if (payment.status === "pending") {
                console.warn("âš ï¸ æª¢æ¸¬åˆ°æœªè™•ç†çš„æ”¯ä»˜:", payment);
                hasPendingPayment = true;
            }
        }

        // 4ï¸âƒ£ æç¤ºç”¨æˆ¶æ‰‹å‹•è™•ç†ï¼Œæˆ–è€…ä½ å¯ä»¥åœ¨å¾Œç«¯å¼·åˆ¶å–æ¶ˆå®ƒå€‘
        if (hasPendingPayment) {
            alert("âš ï¸ ä½ æœ‰æœªå®Œæˆçš„æ”¯ä»˜ï¼Œè«‹å…ˆè™•ç†å¾Œå†ç¹¼çºŒï¼");
        }

        // 5ï¸âƒ£ æ›´æ–° UI é¡¯ç¤ºç”¨æˆ¶è³‡è¨Š
        document.getElementById('user-info').textContent = JSON.stringify(authResult.user, null, 2);
        alert(`ç™»å…¥æˆåŠŸï¼ç”¨æˆ¶å: ${authResult.user.username}`);

        // 6ï¸âƒ£ ç™¼é€ accessToken åˆ°å¾Œç«¯é©—è­‰
        const response = await fetch("https://tubular-kelpie-4997f4.netlify.app/.netlify/functions/verifyLogin", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ accessToken: authResult.accessToken }) // ç¢ºä¿ accessToken æ­£ç¢ºå‚³é
        });

        const result = await response.json();
        console.log("ä¼ºæœå™¨å›æ‡‰:", result);

        if (result.error) {
            alert("é©—è­‰å¤±æ•—ï¼š" + result.error);
        } else {
            alert("ç™»å…¥é©—è­‰æˆåŠŸï¼");
        }
    } catch (error) {
        alert("ç™»å…¥å¤±æ•—: " + error.message);
        console.error("âŒ ç™»å…¥å¤±æ•—:", error);
    }
}



        // æ”¯ä»˜åŠŸèƒ½ (è·³éä¼ºæœå™¨é©—è­‰)
    async function pay() {
    if (!currentUser) return alert("è«‹å…ˆç™»å…¥ï¼");

    try {
        const paymentData = {
            amount: 3.14,
            memo: "æ¸¬è©¦æ”¯ä»˜",
            metadata: { test: "123" }
        };

        const paymentCallbacks = {
            onReadyForServerApproval: async (paymentId) => {
                console.log("æ”¯ä»˜ç­‰å¾…æ‰¹å‡†:", paymentId);

                // ğŸ”¹ é€™è£¡è«‹æ±‚ä¼ºæœå™¨æ‰¹å‡†æ”¯ä»˜
                try {
                    const response = await fetch("https://tubular-kelpie-4997f4.netlify.app/.netlify/functions/approvePayment", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ paymentId })
                    });

                    const result = await response.json();
                    if (result.success) {
                        console.log("æ”¯ä»˜å·²æ‰¹å‡†ï¼Œäº¤æ˜“ID:", result.txid);
                    } else {
                        console.error("æ‰¹å‡†æ”¯ä»˜å¤±æ•—:", result.error);
                    }
                } catch (error) {
                    console.error("ä¼ºæœå™¨éŒ¯èª¤:", error);
                }
            },
            onReadyForServerCompletion: (paymentId, txid) => {
                alert("ğŸ’° æ”¯ä»˜æˆåŠŸï¼äº¤æ˜“ID: " + txid);
            },
            onCancel: (paymentId) => {
                alert("âŒ ç”¨æˆ¶å–æ¶ˆæ”¯ä»˜");
            },
            onError: (error) => {
                alert("æ”¯ä»˜éŒ¯èª¤: " + error.message);
            }
        };

        const payment = await Pi.createPayment(paymentData, paymentCallbacks);
        console.log("æ”¯ä»˜å·²ç™¼èµ·:", payment);
    } catch (error) {
        alert("æ”¯ä»˜å¤±æ•—: " + error.message);
    }
}

    </script>
</body>
</html>
