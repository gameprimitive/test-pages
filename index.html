<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi ç®€æ˜“æ”¯ä»˜æµ‹è¯•</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <script>
        // åˆå§‹åŒ– SDK
        Pi.init({ 
            version: "2.0",
            sandbox: true // âœ… å¿…é¡»å¯ç”¨æ²™ç›’æ¨¡å¼
			
        });

        let currentUser = null; // å®šä¹‰ currentUser å˜é‡

        // å¤„ç†æœªå®Œæˆçš„æ”¯ä»˜
        function onIncompletePaymentFound(payment) {
            console.log("âš ï¸ å‘ç°æœªå®Œæˆçš„æ”¯ä»˜:", payment);
            // åœ¨æ­¤å¤„ç†æœªå®Œæˆçš„æ”¯ä»˜ï¼Œä¾‹å¦‚å‘æœåŠ¡å™¨è¯·æ±‚æ”¯ä»˜çŠ¶æ€
            handleIncompletePayment(payment);
        }

        // ç™»å½•åŠŸèƒ½
        async function login() {
            try {
                // 1ï¸âƒ£ è¿›è¡Œ Pi Network èº«ä»½éªŒè¯
                const authResult = await Pi.authenticate(['username', 'wallet_address', 'payments'], onIncompletePaymentFound);
                console.log("âœ… ç™»å½•æˆåŠŸ", authResult);
                currentUser = authResult.user; // å°†ç”¨æˆ·ä¿¡æ¯å­˜å‚¨åœ¨ currentUser å˜é‡ä¸­
                // å¤„ç†ç™»å½•åçš„é€»è¾‘
                alert("ç™»å½•æˆåŠŸï¼");
            } catch (error) {
                console.error("âŒ ç™»å½•å¤±è´¥:", error);
                alert("ç™»å½•å¤±è´¥ï¼š" + error.message);
            }
        }




async function onIncompletePaymentFound(payment) {
  console.log('âš ï¸ å‘ç°æœªå®Œæˆçš„æ”¯ä»˜:', payment);
  
  // æç¤ºç”¨æˆ·é€‰æ‹©ç»§ç»­æˆ–å–æ¶ˆæ”¯ä»˜
  const userChoice = confirm(`æ‚¨æœ‰ä¸€ç¬”æœªå®Œæˆçš„æ”¯ä»˜ï¼š${payment.memo}ï¼Œé‡‘é¢ï¼š${payment.amount} Piã€‚æ˜¯å¦ç»§ç»­å®Œæˆæ”¯ä»˜ï¼Ÿ`);

  if (userChoice) {
    // ç”¨æˆ·é€‰æ‹©ç»§ç»­æ”¯ä»˜
    handleIncompletePayment(payment);
  } else {
    // ç”¨æˆ·é€‰æ‹©å–æ¶ˆæ”¯ä»˜
    cancelPayment(payment);
  }
}
function handleIncompletePayment(payment) {
    if (!payment || !payment.identifier || !payment.transaction) {
        console.error("âŒ æ”¯ä»˜ä¿¡æ¯ç¼ºå¤±:", payment);
        return;
    }

    const payment_id = payment.identifier; // æå–æ”¯ä»˜ ID
    const txid = payment.transaction.txid; // æå–äº¤æ˜“ IDï¼ˆå¦‚æœæœ‰ï¼‰
    
    if (!txid) {
        console.warn("âš ï¸ äº¤æ˜“ ID ç¼ºå¤±ï¼Œå¯èƒ½æœªä¸Šé“¾:", payment);
        return;
    }

    console.log("ğŸ”„ é‡æ–°å°è¯•å®Œæˆæ”¯ä»˜:", payment_id, txid);

    fetch("https://tubular-kelpie-4997f4.netlify.app/.netlify/functions/completepayment", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            payment_id: payment_id,
            txid: txid
        })
    })
    .then(response => response.json())
    .then(result => {
        console.log("âœ… æ”¯ä»˜å®Œæˆç»“æœ:", result);
    })
    .catch(error => {
        console.error("âŒ æ”¯ä»˜è¯·æ±‚å¤±è´¥:", error);
    });
}

function cancelPayment(payment) {
  fetch('/server/cancel_payment', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ paymentId: payment.identifier }),
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      console.log('âœ… æ”¯ä»˜å·²å–æ¶ˆ');
      
      // è¿™é‡Œæ‰‹åŠ¨è§¦å‘ onCancel
      if (typeof paymentCallbacks.onCancel === "function") {
        paymentCallbacks.onCancel(payment.identifier);
      }
      
    } else {
      console.error('âŒ æ”¯ä»˜å–æ¶ˆå¤±è´¥:', data.error);
    }
  })
  .catch(error => {
    console.error('âŒ æ”¯ä»˜å–æ¶ˆå¤„ç†å¤±è´¥:', error);
  });
}

        // æ”¯ä»˜åŠŸèƒ½
       async function pay() {
    if (!currentUser) return alert("è¯·å…ˆç™»å½•ï¼");

    try {
        const paymentData = {
            amount: 3.14,
            memo: "æµ‹è¯•æ”¯ä»˜",
            metadata: { test: "123" },
            uid: currentUser.uid
        };

        const paymentCallbacks = {
            onReadyForServerApproval: async (paymentId) => {
                console.log("æ”¯ä»˜ç­‰å¾…æ‰¹å‡†:", paymentId);
                const response = await fetch("https://tubular-kelpie-4997f4.netlify.app/.netlify/functions/approvePayment", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ paymentId, uid: currentUser.uid }) // ä¼ é€’ uid
                });
                const result = await response.json();
                if (result.success) {
                    console.log("æ”¯ä»˜å·²æ‰¹å‡†ï¼Œäº¤æ˜“ID:", result.txid);
                } else {
                    console.error("æ”¯ä»˜æ‰¹å‡†å¤±è´¥:", result.error);
                }
            },
            onReadyForServerCompletion: async (paymentId, txid) => {
                console.log("æ”¯ä»˜å®Œæˆï¼Œé€šçŸ¥åç«¯:", paymentId, txid);

    try {
        const response = await fetch("https://tubular-kelpie-4997f4.netlify.app/.netlify/functions/completepayment", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ payment_id: paymentId, txid: txid })
        });

        if (!response.ok) throw new Error(`HTTP é”™è¯¯! çŠ¶æ€ç : ${response.status}`);

        const result = await response.json();
        console.log("âœ… æ”¯ä»˜å®Œæˆç»“æœ:", result);
    } catch (error) {
        console.error("âŒ æ”¯ä»˜è¯·æ±‚å¤±è´¥:", error);
    }
            },
            onCancel: (paymentId) => {
                alert("ç”¨æˆ·å–æ¶ˆæ”¯ä»˜");
            },
            onError: (error) => {
                console.error("æ”¯ä»˜é”™è¯¯:", error);
                alert("æ”¯ä»˜é”™è¯¯: " + (error.response ? JSON.stringify(error.response.data) : error.message));
            }
        };

        const payment = await Pi.createPayment(paymentData, paymentCallbacks);
        console.log("æ”¯ä»˜å·²å‘èµ·:", payment);
    } catch (error) {
        alert("æ”¯ä»˜å¤±è´¥: " + error.message);
    }
}

    </script>
</head>
<body>
    <h1>Pi æ”¯ä»˜æµ‹è¯• </h1>
    
    <button onclick="login()">1. ç™»å½• Pi è´¦å·</button>
    <button onclick="pay()" style="margin-top:20px">2. å‘èµ·æ”¯ä»˜</button>
    
    <h2>ç”¨æˆ·ä¿¡æ¯ï¼š</h2>
    <pre id="user-info">å°šæœªç™»å½•</pre>
</body>
</html>
