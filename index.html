<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi ç®€æ˜“æ”¯ä»˜æµ‹è¯•</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <script>
        // åˆå§‹åŒ– SDK
        Pi.init({ 
            version: "2.0",
            sandbox: true // âœ… å¿…é¡»å¯ç”¨æ²™ç›’æ¨¡å¼
        });

        let currentUser = null; // å®šä¹‰ currentUser å˜é‡

        // å¤„ç†æœªå®Œæˆçš„æ”¯ä»˜
        function onIncompletePaymentFound(payment) {
            console.log("âš ï¸ å‘ç°æœªå®Œæˆçš„æ”¯ä»˜:", payment);
            // åœ¨æ­¤å¤„ç†æœªå®Œæˆçš„æ”¯ä»˜ï¼Œä¾‹å¦‚å‘æœåŠ¡å™¨è¯·æ±‚æ”¯ä»˜çŠ¶æ€
            handleIncompletePayment(payment);
        }

        // ç™»å½•åŠŸèƒ½
        async function login() {
            try {
                // 1ï¸âƒ£ è¿›è¡Œ Pi Network èº«ä»½éªŒè¯
                const authResult = await Pi.authenticate(['username', 'wallet_address', 'payments'], onIncompletePaymentFound);
                console.log("âœ… ç™»å½•æˆåŠŸ", authResult);
                currentUser = authResult.user; // å°†ç”¨æˆ·ä¿¡æ¯å­˜å‚¨åœ¨ currentUser å˜é‡ä¸­
                // å¤„ç†ç™»å½•åçš„é€»è¾‘
                alert("ç™»å½•æˆåŠŸï¼");
            } catch (error) {
                console.error("âŒ ç™»å½•å¤±è´¥:", error);
                alert("ç™»å½•å¤±è´¥ï¼š" + error.message);
            }
        }




  async function handleIncompletePayment(payment) {
  try {
    const response = await fetch("https://tubular-kelpie-4997f4.netlify.app/.netlify/functions/verifyPayment", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ paymentId: payment.identifier }),
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const paymentData = await response.json();
    console.log("ğŸ” Pi API åŸå§‹å“åº”:", paymentData);

    // çŠ¶æ€è§£æé€»è¾‘
    const status = paymentData.status || {};
    const isCancelled = status.cancelled || status.user_cancelled;

    // çŠ¶æ€å†³ç­–æ ‘
    if (isCancelled) {
      console.log("âŒ æ”¯ä»˜å·²è¢«å–æ¶ˆ");
      await Pi.cancelPayment(payment.identifier);
      return;
    }

    if (status.developer_completed) {
      console.log("âœ… æ”¯ä»˜å·²å®Œæˆ");
      return;
    }

    if (status.transaction_verified) {
      console.log("ğŸ”„ äº¤æ˜“å·²éªŒè¯ï¼Œæ­£åœ¨å®Œæˆæ”¯ä»˜æµç¨‹...");
      await Pi.completePayment(payment.identifier);
      console.log("âœ… æ”¯ä»˜æœ€ç»ˆç¡®è®¤å®Œæˆ");
      return;
    }

    if (status.developer_approved) {
      console.log("âš ï¸ æ”¯ä»˜å·²æ‰¹å‡†ä½†æœªéªŒè¯ï¼Œç­‰å¾…åŒºå—é“¾ç¡®è®¤...");
      // æ·»åŠ è½®è¯¢æ£€æŸ¥
      const checkInterval = setInterval(async () => {
        const updated = await verifyPayment(payment.identifier);
        if (updated.status.transaction_verified) {
          clearInterval(checkInterval);
          await Pi.completePayment(payment.identifier);
        }
      }, 5000);
      return;
    }

    console.warn("ğŸ”„ æ”¯ä»˜å¤„äºåˆå§‹çŠ¶æ€ï¼Œç­‰å¾…å¤„ç†...");
  } catch (error) {
    console.error("âŒ æ”¯ä»˜çŠ¶æ€æ£€æŸ¥å¤±è´¥:", error);
    setTimeout(() => handleIncompletePayment(payment), 10000); // 10ç§’åé‡è¯•
  }
}

        // æ”¯ä»˜åŠŸèƒ½
        async function pay() {
            if (!currentUser) return alert("è¯·å…ˆç™»å½•ï¼");

            try {
                const paymentData = {
                    amount: 3.14,
                    memo: "æµ‹è¯•æ”¯ä»˜",
                    metadata: { test: "123" },
                    uid: currentUser.uid // ä½¿ç”¨ currentUser å˜é‡
                };

                const paymentCallbacks = {
                    onReadyForServerApproval: async (paymentId) => {
                        console.log("æ”¯ä»˜ç­‰å¾…æ‰¹å‡†:", paymentId);
                        // å‘åç«¯è¯·æ±‚æ‰¹å‡†æ”¯ä»˜
                        const response = await fetch("https://tubular-kelpie-4997f4.netlify.app/.netlify/functions/approvePayment", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ paymentId })
                        });
                        const result = await response.json();
                        if (result.success) {
                            console.log("æ”¯ä»˜å·²æ‰¹å‡†ï¼Œäº¤æ˜“ID:", result.txid);
                        } else {
                            console.error("æ”¯ä»˜æ‰¹å‡†å¤±è´¥:", result.error);
                        }
                    },
                    onReadyForServerCompletion: (paymentId, txid) => {
                        alert("æ”¯ä»˜æˆåŠŸï¼äº¤æ˜“ID: " + txid);
                    },
                    onCancel: (paymentId) => {
                        alert("ç”¨æˆ·å–æ¶ˆæ”¯ä»˜");
                    },
                    onError: (error) => {
                        alert("æ”¯ä»˜é”™è¯¯: " + error.message);
                    }
                };

                const payment = await Pi.createPayment(paymentData, paymentCallbacks);
                console.log("æ”¯ä»˜å·²å‘èµ·:", payment);
            } catch (error) {
                alert("æ”¯ä»˜å¤±è´¥: " + error.message);
            }
        }
    </script>
</head>
<body>
    <h1>Pi æ”¯ä»˜æµ‹è¯• </h1>
    
    <button onclick="login()">1. ç™»å½• Pi è´¦å·</button>
    <button onclick="pay()" style="margin-top:20px">2. å‘èµ·æ”¯ä»˜</button>
    
    <h2>ç”¨æˆ·ä¿¡æ¯ï¼š</h2>
    <pre id="user-info">å°šæœªç™»å½•</pre>
</body>
</html>
